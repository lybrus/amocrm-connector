![Test](https://github.com/lybrus/amocrm-connector/workflows/Test%20and%20publish/badge.svg)

# Node.js [AmoCRM](https://www.amocrm.ru/developers/content/crm_platform/platform-abilities) api connector

## Описание

### Авторизация

Подробно про AmoCRM реализацию OAuth2 авторизации в [официально документации](https://www.amocrm.ru/developers/content/oauth/step-by-step)
Также можете посмотреть [видео](https://youtu.be/eK7xYAbxJHo) от создателей другой библиотеки [https://github.com/UsefulWeb/AmoCRM](https://github.com/UsefulWeb/AmoCRM).

1. Регистрация вашей интеграции
2. Переход пользователя по ссылке выдачи доступа пользователем вашему приложению. Ссылку получить можно методом `amocrm.getOAuthLink`
3. Обработка запроса на redirect uri, здесь должен быть запущен ваш сервер. В виде гет параметра amocrm передаст код авторизации.
Его необходимо обменять на токен с помощью метода `amocrm.getToken`. Пример реализации смотрите в файле `testing/server.js`

### Объект доступа к хранилищу (store)

Хранилище позволяет:

* сохранять/загружать токен
* кэшировать сущности для снижения трафика и нагрузки на AmoCRM api, испольуется заголовок `If-Modified-Since`

Объект должен иметь 2 асинхронных метода для работы с key/value хранилищем:

* `get`:
    * аргументы
        * `key` - ключ данных
    * возвращаемое значение

```javascript
{
    // значение
    value,
    // дата и время обновления
    updatedAt
}
```
* `set`:
    * аргументы:
        * `key` - ключ
        * `value` - значение
        * `updatedAt` - дата последнего обновления
        * `expiresIn` - время жизни данных в секундах

Реализация хранилища на ваше усмотрение. Удобнее всего использовать для этих целей базу данных.

Пример простого рантайм хранилища:

```javascript
const store = {
    _data: {},
    async get(key) {
        return this._data[key]
    },
    async set(key, value, updatedAt, expiresIn) {
        this._data[key] = { value, updatedAt }
    }
}
```

## Документация

### `AmoCRM`

```javascript
const amocrm = new AmoCRM({
    credential: {
        // Домен вашего аккаунта. Ссылка на ваш аккаунт выглядит как https://[domain].amocrm.ru
        domain,
        // ID интеграции из "ключи и доступы" вашей интеграции
        integrationId,
        // Секретный ключ из "ключи и доступы" вашей интеграции
        secretKey,
        // url из настроек вашей интеграции
        redirectUri
    },
    // необязательный параметр, объект токена полученный ранее
    token,
    // Дополнительные параметры, необязательный параметр
    options: {
        // Boolean, включает режим отладки, выводит логи в консоль. Необязательный, значение по-умолчанию false
        debug,
        // Объект для доступа к вашему хранилищу. Почитать можно в разделе Хранилище. Необязательный параметр.
        store,
        // Автоматический контроль refresh токена, за сколько секунд до окончания его срока действия обновлять.
        // 0 - не использовать автоматический контроль. Значение по-умолчанию 0.
        // Не используйте данный параметр если запускаете больше инстанса вашего сервера, контролируйте из отдельной cron job
        refreshTokenUpdateOffset
    }
})
```

### События

Класс AmoCRM унаследован от класса EventEmitter.
* Подписка на событие `on(eventName, listener)`
* Отписка от события `removeListener(eventName, listener)`

Больше информации можно почитать в официальной [документации](https://nodejs.org/api/events.html).

#### Список событий

| Имя события | Параметры коллбэка      |
|-------------|-------------------------|
| token       | `token` - объект токена |


### Авторизация

#### `amocrm.getOAuthLink(state, mode)`

`state` - уникальная строка, которая будет передана вам обратно в виде гет параметра после выдачи доступа вашему приложению.
`mode` - режим обработки redirect uri, по-умолчанию `post_message`
Возвращает ссылку для OAuth авторизации

#### `async amocrm.getToken({ code, refreshToken })`

Получает токен по коду авторизации или токену обновления.
